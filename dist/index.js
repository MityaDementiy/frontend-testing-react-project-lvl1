"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = require("fs");

var _path = _interopRequireDefault(require("path"));

var _cheerio = _interopRequireDefault(require("cheerio"));

var _axios = _interopRequireDefault(require("axios"));

var _debug = _interopRequireDefault(require("debug"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _debug.default)('page-loader');

const loader = async (url, directory) => {
  const cwd = process.cwd();
  const fileName = (0, _utils.formatUrl)(url);

  const filePath = _path.default.join(directory, fileName);

  const fileDirectoryUrl = (0, _utils.makeFileDirectoryUrl)(filePath);
  const urlObj = new URL(url);
  const {
    hostname,
    origin
  } = urlObj;
  const pageData = await (0, _utils.get)(url);

  const $ = _cheerio.default.load(pageData, {
    decodeEntities: false
  });

  const imagesLinks = [];
  $('img').toArray().forEach(element => {
    const {
      src
    } = element.attribs;

    if (!src) {
      return;
    }

    if (src.startsWith('http')) {
      const srcObj = new URL(src);
      const {
        hostname: srcHostName
      } = srcObj;

      if (srcHostName === hostname) {
        imagesLinks.push(src);
        const newSrc = (0, _utils.makeAssetUrl)(src, fileDirectoryUrl, url);
        element.attribs.src = newSrc;
      }
    }

    if (!src.startsWith('http') && src.startsWith('/')) {
      const newSrc = (0, _utils.makeAssetUrl)(src, fileDirectoryUrl, url);
      element.attribs.src = newSrc;

      const absolutePath = _path.default.join(origin, src);

      imagesLinks.push(absolutePath);
    }
  });
  $('link').toArray().forEach(element => {
    const {
      href
    } = element.attribs;

    if (!href) {
      return;
    }

    if (href.startsWith('http')) {
      const hrefObj = new URL(href);
      const {
        hostname: hrefHostName
      } = hrefObj;

      if (hrefHostName === hostname) {
        const newHref = (0, _utils.makeAssetUrl)(href, fileDirectoryUrl, url);
        element.attribs.href = newHref;
      }
    }

    if (!href.startsWith('http')) {
      const newHref = (0, _utils.makeAssetUrl)(href, fileDirectoryUrl, url);
      element.attribs.href = newHref;
    }
  });
  log('images urls:', imagesLinks);
  $('script').toArray().forEach(element => {
    const {
      src
    } = element.attribs;

    if (!src) {
      return;
    }

    if (src.startsWith('http')) {
      const srcObj = new URL(src);
      const {
        hostname: srcHostName
      } = srcObj;

      if (srcHostName === hostname) {
        const newSrc = (0, _utils.makeAssetUrl)(src, fileDirectoryUrl, url);
        element.attribs.src = newSrc;
      }
    }

    if (!src.startsWith('http')) {
      const newSrc = (0, _utils.makeAssetUrl)(src, fileDirectoryUrl, url);
      element.attribs.src = newSrc;
    }
  });
  const processedData = $.html();

  if (directory !== cwd) {
    try {
      _fs.promises.mkdir(directory);
    } catch (error) {
      console.error(error);
    }
  }

  if ((0, _utils.hasAssets)(imagesLinks)) {
    _fs.promises.mkdir(fileDirectoryUrl);

    const requestImages = imagesLinks.map(url => _axios.default.get(url, {
      responseType: 'arraybuffer'
    }).then(({
      data
    }) => data));
    const processedImagesUrls = imagesLinks.map(link => (0, _utils.makeAssetUrl)(link, fileDirectoryUrl, url));
    Promise.all(requestImages).then(responses => {
      responses.forEach((response, index) => {
        _fs.promises.writeFile(processedImagesUrls[index], response);
      });
    }).catch(err => {
      console.error(err);
    });
  }

  try {
    _fs.promises.writeFile(filePath, processedData);
  } catch (error) {
    console.error(error);
  }

  return filePath;
};

var _default = loader;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJsb2ciLCJsb2FkZXIiLCJ1cmwiLCJkaXJlY3RvcnkiLCJjd2QiLCJwcm9jZXNzIiwiZmlsZU5hbWUiLCJmaWxlUGF0aCIsInBhdGgiLCJqb2luIiwiZmlsZURpcmVjdG9yeVVybCIsInVybE9iaiIsIlVSTCIsImhvc3RuYW1lIiwib3JpZ2luIiwicGFnZURhdGEiLCIkIiwiY2hlZXJpbyIsImxvYWQiLCJkZWNvZGVFbnRpdGllcyIsImltYWdlc0xpbmtzIiwidG9BcnJheSIsImZvckVhY2giLCJlbGVtZW50Iiwic3JjIiwiYXR0cmlicyIsInN0YXJ0c1dpdGgiLCJzcmNPYmoiLCJzcmNIb3N0TmFtZSIsInB1c2giLCJuZXdTcmMiLCJhYnNvbHV0ZVBhdGgiLCJocmVmIiwiaHJlZk9iaiIsImhyZWZIb3N0TmFtZSIsIm5ld0hyZWYiLCJwcm9jZXNzZWREYXRhIiwiaHRtbCIsImZzIiwibWtkaXIiLCJlcnJvciIsImNvbnNvbGUiLCJyZXF1ZXN0SW1hZ2VzIiwibWFwIiwiYXhpb3MiLCJnZXQiLCJyZXNwb25zZVR5cGUiLCJ0aGVuIiwiZGF0YSIsInByb2Nlc3NlZEltYWdlc1VybHMiLCJsaW5rIiwiUHJvbWlzZSIsImFsbCIsInJlc3BvbnNlcyIsInJlc3BvbnNlIiwiaW5kZXgiLCJ3cml0ZUZpbGUiLCJjYXRjaCIsImVyciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBSUEsTUFBTUEsR0FBRyxHQUFHLG9CQUFNLGFBQU4sQ0FBWjs7QUFFQSxNQUFNQyxNQUFNLEdBQUcsT0FBT0MsR0FBUCxFQUFZQyxTQUFaLEtBQTBCO0FBQ3ZDLFFBQU1DLEdBQUcsR0FBR0MsT0FBTyxDQUFDRCxHQUFSLEVBQVo7QUFDQSxRQUFNRSxRQUFRLEdBQUcsc0JBQVVKLEdBQVYsQ0FBakI7O0FBQ0EsUUFBTUssUUFBUSxHQUFHQyxjQUFLQyxJQUFMLENBQVVOLFNB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RUQsU0FBT2pDLFFBQVA7QUFDRCxDQTNHRDs7ZUE2R2VOLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwcm9taXNlcyBhcyBmcyB9IGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNoZWVyaW8gZnJvbSAnY2hlZXJpbyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcblxuaW1wb3J0IHtcbiAgZm9ybWF0VXJsLCBnZXQsIG1ha2VGaWxlRGlyZWN0b3J5VXJsLCBtYWtlQXNzZXRVcmwsIGhhc0Fzc2V0cyxcbn0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGxvZyA9IGRlYnVnKCdwYWdlLWxvYWRlcicpO1xuXG5jb25zdCBsb2FkZXIgPSBhc3luYyAodXJsLCBkaXJlY3RvcnkpID0+IHtcbiAgY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKTtcbiAgY29uc3QgZmlsZU5hbWUgPSBmb3JtYXRVcmwodXJsKTtcbiAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oZGlyZWN0b3J5LCBmaWxlTmFtZSk7XG4gIGNvbnN0IGZpbGVEaXJlY3RvcnlVcmwgPSBtYWtlRmlsZURpcmVjdG9yeVVybChmaWxlUGF0aCk7XG4gIGNvbnN0IHVybE9iaiA9IG5ldyBVUkwodXJsKTtcbiAgY29uc3QgeyBob3N0bmFtZSwgb3JpZ2luIH0gPSB1cmxPYmo7XG5cbiAgY29uc3QgcGFnZURhdGEgPSBhd2FpdCBnZXQodXJsKTtcbiAgY29uc3QgJCA9IGNoZWVyaW8ubG9hZChwYWdlRGF0YSwgeyBkZWNvZGVFbnRpdGllczogZmFsc2UgfSk7XG4gIGNvbnN0IGltYWdlc0xpbmtzID0gW107XG5cbiAgJCgnaW1nJykudG9BcnJheSgpLmZvckVhY2goKGVsZW1lbnQpID0+IHtcbiAgICBjb25zdCB7IHNyYyB9ID0gZWxlbWVudC5hdHRyaWJzO1xuICAgIGlmICghc3JjKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChzcmMuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICBjb25zdCBzcmNPYmogPSBuZXcgVVJMKHNyYyk7XG4gICAgICBjb25zdCB7IGhvc3RuYW1lOiBzcmNIb3N0TmFtZSB9ID0gc3JjT2JqO1xuICAgICAgaWYgKHNyY0hvc3ROYW1lID09PSBob3N0bmFtZSkge1xuICAgICAgICBpbWFnZXNMaW5rcy5wdXNoKHNyYyk7XG4gICAgICAgIGNvbnN0IG5ld1NyYyA9IG1ha2VBc3NldFVybChzcmMsIGZpbGVEaXJlY3RvcnlVcmwsIHVybCk7XG4gICAgICAgIGVsZW1lbnQuYXR0cmlicy5zcmMgPSBuZXdTcmM7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghc3JjLnN0YXJ0c1dpdGgoJ2h0dHAnKSAmJiBzcmMuc3RhcnRzV2l0aCgnLycpKSB7XG4gICAgICBjb25zdCBuZXdTcmMgPSBtYWtlQXNzZXRVcmwoc3JjLCBmaWxlRGlyZWN0b3J5VXJsLCB1cmwpO1xuICAgICAgZWxlbWVudC5hdHRyaWJzLnNyYyA9IG5ld1NyYztcbiAgICAgIGNvbnN0IGFic29sdXRlUGF0aCA9IHBhdGguam9pbihvcmlnaW4sIHNyYyk7XG4gICAgICBpbWFnZXNMaW5rcy5wdXNoKGFic29sdXRlUGF0aCk7XG4gICAgfVxuICB9KTtcblxuICAkKCdsaW5rJykudG9BcnJheSgpLmZvckVhY2goKGVsZW1lbnQpID0+IHtcbiAgICBjb25zdCB7IGhyZWYgfSA9IGVsZW1lbnQuYXR0cmlicztcbiAgICBpZiAoIWhyZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGhyZWYuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICBjb25zdCBocmVmT2JqID0gbmV3IFVSTChocmVmKTtcbiAgICAgIGNvbnN0IHsgaG9zdG5hbWU6IGhyZWZIb3N0TmFtZSB9ID0gaHJlZk9iajtcbiAgICAgIGlmIChocmVmSG9zdE5hbWUgPT09IGhvc3RuYW1lKSB7XG4gICAgICAgIGNvbnN0IG5ld0hyZWYgPSBtYWtlQXNzZXRVcmwoaHJlZiwgZmlsZURpcmVjdG9yeVVybCwgdXJsKTtcbiAgICAgICAgZWxlbWVudC5hdHRyaWJzLmhyZWYgPSBuZXdIcmVmO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoIWhyZWYuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICBjb25zdCBuZXdIcmVmID0gbWFrZUFzc2V0VXJsKGhyZWYsIGZpbGVEaXJlY3RvcnlVcmwsIHVybCk7XG4gICAgICBlbGVtZW50LmF0dHJpYnMuaHJlZiA9IG5ld0hyZWY7XG4gICAgfVxuICB9KTtcblxuICBsb2coJ2ltYWdlcyB1cmxzOicsIGltYWdlc0xpbmtzKTtcblxuICAkKCdzY3JpcHQnKS50b0FycmF5KCkuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IHsgc3JjIH0gPSBlbGVtZW50LmF0dHJpYnM7XG4gICAgaWYgKCFzcmMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHNyYy5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICAgIGNvbnN0IHNyY09iaiA9IG5ldyBVUkwoc3JjKTtcbiAgICAgIGNvbnN0IHsgaG9zdG5hbWU6IHNyY0hvc3ROYW1lIH0gPSBzcmNPYmo7XG4gICAgICBpZiAoc3JjSG9zdE5hbWUgPT09IGhvc3RuYW1lKSB7XG4gICAgICAgIGNvbnN0IG5ld1NyYyA9IG1ha2VBc3NldFVybChzcmMsIGZpbGVEaXJlY3RvcnlVcmwsIHVybCk7XG4gICAgICAgIGVsZW1lbnQuYXR0cmlicy5zcmMgPSBuZXdTcmM7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghc3JjLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgY29uc3QgbmV3U3JjID0gbWFrZUFzc2V0VXJsKHNyYywgZmlsZURpcmVjdG9yeVVybCwgdXJsKTtcbiAgICAgIGVsZW1lbnQuYXR0cmlicy5zcmMgPSBuZXdTcmM7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBwcm9jZXNzZWREYXRhID0gJC5odG1sKCk7XG5cbiAgaWYgKGRpcmVjdG9yeSAhPT0gY3dkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZzLm1rZGlyKGRpcmVjdG9yeSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChoYXNBc3NldHMoaW1hZ2VzTGlua3MpKSB7XG4gICAgZnMubWtkaXIoZmlsZURpcmVjdG9yeVVybCk7XG4gICAgY29uc3QgcmVxdWVzdEltYWdlcyA9IGltYWdlc0xpbmtzLm1hcCgodXJsKSA9PiBheGlvcy5nZXQodXJsLCB7IHJlc3BvbnNlVHlwZTogJ2FycmF5YnVmZmVyJyB9KS50aGVuKCh7IGRhdGEgfSkgPT4gZGF0YSkpO1xuICAgIGNvbnN0IHByb2Nlc3NlZEltYWdlc1VybHMgPSBpbWFnZXNMaW5rcy5tYXAoKGxpbmspID0+IG1ha2VBc3NldFVybChsaW5rLCBmaWxlRGlyZWN0b3J5VXJsLCB1cmwpKTtcblxuICAgIFByb21pc2UuYWxsKHJlcXVlc3RJbWFnZXMpXG4gICAgICAudGhlbigocmVzcG9uc2VzKSA9PiB7XG4gICAgICAgIHJlc3BvbnNlcy5mb3JFYWNoKChyZXNwb25zZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICBmcy53cml0ZUZpbGUocHJvY2Vzc2VkSW1hZ2VzVXJsc1tpbmRleF0sIHJlc3BvbnNlKTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIGZzLndyaXRlRmlsZShmaWxlUGF0aCwgcHJvY2Vzc2VkRGF0YSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gIH1cblxuICByZXR1cm4gZmlsZVBhdGg7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBsb2FkZXI7XG4iXX0=